{"version":3,"file":"text-events-4553950a.js","sources":["../../tests/text-events.ts"],"sourcesContent":["/*\n * If not stated otherwise in this file or this component's LICENSE file the\n * following copyright and licenses apply:\n *\n * Copyright 2023 Comcast Cable Communications Management, LLC.\n *\n * Licensed under the Apache License, Version 2.0 (the License);\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  type INode,\n  type ITextNode,\n  type RendererMain,\n  type Dimensions,\n  type NodeLoadedEventHandler,\n  type NodeFailedEventHandler,\n} from '@lightningjs/renderer';\nimport { EventEmitter } from '@lightningjs/renderer/utils';\nimport type { ExampleSettings } from '../common/ExampleSettings.js';\n\nconst HEADER_SIZE = 45;\nconst FONT_SIZE = 60;\nconst BUTTON_PADDING = 10;\nconst BEGIN_Y = HEADER_SIZE;\n\nexport default async function ({\n  renderer,\n  driverName,\n  testRoot,\n}: ExampleSettings) {\n  const header = renderer.createTextNode({\n    text: `Text Event Test (${driverName})`,\n    fontSize: HEADER_SIZE,\n    offsetY: -5,\n    parent: testRoot,\n  });\n\n  // Poor man's marquee\n  const sdfLabel = renderer.createTextNode({\n    text: 'SDF:',\n    fontSize: 45,\n    parent: testRoot,\n    x: 100,\n    y: (renderer.settings.appHeight * 1) / 4 - 45 / 2,\n  });\n\n  const marqueeSdf = new BoxedText(\n    {\n      x: 0,\n      y: BEGIN_Y,\n      boxColor1: 0x9f6dffff,\n      boxColor2: 0x00aaaaff,\n      textColor: 0xffffffff,\n      fontFamily: 'Ubuntu',\n      parent: testRoot,\n    },\n    renderer,\n  );\n\n  marqueeSdf.on('afterLayout', () => {\n    marqueeSdf.x = renderer.settings.appWidth / 2 - marqueeSdf.node.width / 2;\n    marqueeSdf.y =\n      (renderer.settings.appHeight * 1) / 4 - marqueeSdf.node.height / 2;\n  });\n\n  const canvasLabel = renderer.createTextNode({\n    text: 'Canvas:',\n    fontSize: 45,\n    parent: testRoot,\n    x: 100,\n    y: (renderer.settings.appHeight * 3) / 4 - 45 / 2,\n  });\n\n  const marqueeCanvas = new BoxedText(\n    {\n      x: 0,\n      y: BEGIN_Y,\n      boxColor1: 0x00aaaaff,\n      boxColor2: 0x9f6dffff,\n      textColor: 0xffffffff,\n      fontFamily: 'NotoSans',\n      parent: testRoot,\n    },\n    renderer,\n  );\n\n  marqueeCanvas.on('afterLayout', () => {\n    marqueeCanvas.x =\n      renderer.settings.appWidth / 2 - marqueeCanvas.node.width / 2;\n    marqueeCanvas.y =\n      (renderer.settings.appHeight * 3) / 4 - marqueeCanvas.node.height / 2;\n  });\n\n  const marqueeText = `The following is a test of the text loaded event...\nFrom Philly's streets to Dutch canal's grace,\nA code symphony spanned time and space.\nLightning 3 emerged, open and free,\nTV apps bloomed like waves on the sea.\n\nJavaScript's art with WebGL's embrace,\nA framework for screens, a virtual space.\nDispersed yet aligned, the team took flight,\nPhiladelphia and Netherlands, day and night.\n\nTogether they wove lines of code,\nInnovation sparked, passion glowed.\nLightning 3 arose, a collaborative dream,\nUniting two lands, a powerful stream.`;\n  const MARQUEE_MAX = 40;\n  let numChars = 0;\n  let i = 0;\n  let state: 'growing' | 'scrolling' | 'shrinking' = 'growing';\n  // Run the marquee scroll\n  setInterval(() => {\n    if (state === 'growing') {\n      numChars++;\n\n      if (numChars <= MARQUEE_MAX && numChars <= marqueeText.length - i) {\n        // No change\n      } else if (\n        numChars >= MARQUEE_MAX &&\n        numChars <= marqueeText.length - i\n      ) {\n        numChars = MARQUEE_MAX;\n        state = 'scrolling';\n      } else if (numChars > 0) {\n        state = 'shrinking';\n      }\n    } else if (state === 'shrinking') {\n      i++;\n      numChars--;\n      if (numChars === 0) {\n        i = 0;\n        state = 'growing';\n      }\n    } else {\n      i++;\n      if (numChars >= marqueeText.length - i) {\n        state = 'shrinking';\n      }\n    }\n    // Set the text\n    marqueeSdf.text = marqueeText.substring(i, i + numChars);\n    marqueeCanvas.text = marqueeSdf.text;\n  }, 50);\n\n  const textFailedEventTest = renderer.createTextNode({\n    y: 50,\n    fontFamily: '$$SDF_FAILURE_TEST$$',\n    textRendererOverride: 'sdf',\n    parent: testRoot,\n    fontSize: 50,\n  });\n\n  let textError: Error | undefined;\n  try {\n    textError = await waitForTextFailed(textFailedEventTest);\n  } catch (e: unknown) {\n    // Nothing\n  }\n\n  textFailedEventTest.fontFamily = 'Ubuntu';\n  if (textError) {\n    textFailedEventTest.text = 'Failure Event Test Passed!';\n    textFailedEventTest.color = 0x00ff00ff;\n  } else {\n    textFailedEventTest.text = 'Failure Event Test Failed!';\n    textFailedEventTest.color = 0xff0000ff;\n  }\n}\n\ninterface BoxedTextProps {\n  x: number;\n  y: number;\n  boxColor1: number;\n  boxColor2: number;\n  textColor: number;\n  fontFamily: string;\n  parent: INode | null;\n}\n\nclass BoxedText extends EventEmitter implements BoxedTextProps {\n  readonly node: INode;\n  readonly textNode: ITextNode;\n  constructor(\n    private props: Partial<BoxedTextProps>,\n    private renderer: RendererMain,\n  ) {\n    super();\n    this.node = renderer.createNode({\n      x: props.x,\n      y: props.y,\n      colorTop: props.boxColor1,\n      colorBottom: props.boxColor2,\n      shader: renderer.createShader('RoundedRectangle', {\n        radius: 10,\n      }),\n      parent: props.parent,\n    });\n\n    this.textNode = renderer.createTextNode({\n      x: 0,\n      y: 0,\n      fontSize: FONT_SIZE,\n      offsetY: -5,\n      alpha: 0,\n      color: props.textColor,\n      fontFamily: props.fontFamily,\n      parent: this.node,\n    });\n\n    this.textNode.on('loaded', this.onTextLoaded);\n  }\n\n  private onTextLoaded: NodeLoadedEventHandler = (target, payload) => {\n    this.layout(payload.dimensions);\n  };\n\n  private layout(textDimensions: Dimensions) {\n    this.node.width = textDimensions.width + BUTTON_PADDING * 2;\n    this.node.height = textDimensions.height + BUTTON_PADDING * 2;\n    this.textNode.x = this.node.width / 2 - textDimensions.width / 2;\n    this.textNode.y = this.node.height / 2 - textDimensions.height / 2;\n    this.textNode.alpha = 1;\n    this.emit('afterLayout');\n  }\n\n  get text(): string {\n    return this.textNode.text;\n  }\n\n  set text(v: string) {\n    this.textNode.text = v;\n  }\n\n  get x(): number {\n    return this.node.x;\n  }\n\n  set x(v: number) {\n    this.node.x = v;\n  }\n\n  get y(): number {\n    return this.node.y;\n  }\n\n  set y(v: number) {\n    this.node.y = v;\n  }\n\n  get boxColor1(): number {\n    return this.node.colorTop;\n  }\n\n  set boxColor1(v: number) {\n    this.node.colorTop = v;\n  }\n\n  get boxColor2(): number {\n    return this.node.colorBottom;\n  }\n\n  set boxColor2(v: number) {\n    this.node.colorBottom = v;\n  }\n\n  get textColor() {\n    return this.textNode.color;\n  }\n\n  set textColor(v: number) {\n    this.textNode.color = v;\n  }\n\n  get fontFamily() {\n    return this.textNode.fontFamily;\n  }\n\n  set fontFamily(v: string) {\n    this.textNode.fontFamily = v;\n  }\n\n  get parent() {\n    return this.node.parent;\n  }\n\n  set parent(v: INode | null) {\n    this.node.parent = v;\n  }\n}\n\nfunction waitForTextFailed(textNode: ITextNode) {\n  return new Promise<Error>((resolve, reject) => {\n    setTimeout(() => {\n      reject(new Error('TIMEOUT'));\n    }, 1000);\n    textNode.once('failed', ((target, payload) => {\n      resolve(payload.error);\n    }) satisfies NodeFailedEventHandler);\n  });\n}\n"],"names":[],"mappings":"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"}